<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>용산구 점포 지도 (최근 3년 강조)</title>
    <!-- 네이버 지도 API -->
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=u5mtazxcnw"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Pretendard', sans-serif; background: #f8f9fa; }
        #map { width: 100%; height: 100vh; }
        
        .iw-container { 
            padding: 12px; 
            min-width: 180px; 
            max-width: 220px;
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            border: 1px solid #f0f0f0;
        }
        .iw-title { font-size: 15px; font-weight: 700; color: #111; margin-bottom: 2px; display: block; }
        .iw-category { font-size: 11px; color: #2563eb; font-weight: 600; margin-bottom: 4px; display: block; }
        .iw-address { font-size: 11px; color: #71717a; margin-bottom: 12px; line-height: 1.4; display: block; }
        .iw-btn-group { display: flex; gap: 6px; }
        .iw-btn {
            flex: 1; text-align: center; color: white; padding: 7px 0;
            text-decoration: none; font-size: 10.5px; border-radius: 6px;
            font-weight: 600; cursor: pointer; border: none; transition: opacity 0.2s;
            white-space: nowrap;
        }
        .iw-btn:active { opacity: 0.8; }
        .btn-visit { background-color: #3b82f6; } 
        .btn-cancel { background-color: #f59e0b; } 
        .btn-naver { background-color: #03c75a; } 

        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 600; color: #333;
            transition: opacity 0.3s;
        }

        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 13px; z-index: 9999;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        #toast.show { opacity: 1; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div style="width:32px; height:32px; border:3px solid #f3f3f3; border-top:3px solid #3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:12px;"></div>
        <div id="loading-text">데이터를 불러오고 있습니다...</div>
    </div>
    <div id="toast">저장 중...</div>
    <div id="map"></div>

    <script>
        // ⚠️ 주의: 아래 주소를 사용자님의 실제 구글 배포 URL로 반드시 변경해야 합니다!
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyCQZ1szZcBwagu38EVUvkTaUCYihREWoI7ybiJkcNl8BsPTXBM6ooOxaM-UdY_qU1k/exec'; 

        var map;
        var infowindow = new naver.maps.InfoWindow({
            borderWidth: 0, backgroundColor: "transparent", disableAnchor: true, pixelOffset: new naver.maps.Point(0, -10)
        });

        var markersMap = {}; 
        var locationsMap = {}; 

        // 색상 설정 (최근 3년 강조)
        const yearColors = {
            "2026": "#E11D48", // 로즈 레드 (올해)
            "2025": "#F59E0B", // 오렌지 (작년)
            "2024": "#3B82F6", // 선명한 블루 (재작년)
            "old": "#475569"   // 그 이전 (차분한 슬레이트 블루)
        };
        const VISITED_COLOR = "#10B981"; // 방문완료 (초록색)

        function initMap() {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5365, 126.9780), 
                zoom: 14, logoControl: false, mapDataControl: false
            });
            naver.maps.Event.addListener(map, "click", () => infowindow.close());
            
            // URL 설정 여부 체크 (플레이스홀더 문구가 그대로 있으면 오류 표시)
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('여기에')) {
                document.getElementById('loading-text').innerText = "오류: GOOGLE_SCRIPT_URL을 설정해 주세요.";
                return;
            }
            loadData();
        }

        async function loadData() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const locations = await response.json();
                
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 300);

                locations.forEach(loc => {
                    if(loc.Lat && loc.Lng) createMarker(loc);
                });
            } catch (e) {
                console.error("데이터 로드 실패:", e);
                document.getElementById('loading-text').innerText = "데이터 로드 실패: URL과 권한 설정을 확인하세요.";
            }
        }

        // 날짜 데이터에서 연도 4자리 추출
        function getYear(dateString) {
            if (!dateString) return null;
            const d = new Date(dateString);
            if (isNaN(d.getTime())) {
                const yearMatch = dateString.toString().match(/\d{4}/);
                return yearMatch ? yearMatch[0] : null;
            }
            return String(d.getFullYear());
        }

        function getIconHtml(loc) {
            const isVisited = String(loc.IsVisited).toUpperCase() === 'TRUE';
            let color = yearColors.old;

            if (isVisited) {
                color = VISITED_COLOR;
            } else {
                const year = getYear(loc.Date);
                color = yearColors[year] || yearColors.old;
            }

            return `<div style="width:24px;height:30px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                        <svg width="24" height="30" viewBox="0 0 32 40">
                            <path d="M16 0C7.2 0 0 7.2 0 16c0 12 16 24 16 24s16-12 16-24c0-8.8-7.2-16-16-16z" fill="${color}"/>
                            <circle cx="16" cy="16" r="6" fill="white"/>
                        </svg>
                    </div>`;
        }

        function getInfoWindowHtml(loc) {
            const isVisited = String(loc.IsVisited).toUpperCase() === 'TRUE';
            const year = getYear(loc.Date);
            let yearTag = year ? ` (${year})` : "";
            const categoryContent = (loc.Category || '') + yearTag;
            const categoryTag = categoryContent ? `<span class="iw-category">${categoryContent}</span>` : '';
            
            const formatDate = (dateString) => {
                if (!dateString) return "";
                const d = new Date(dateString);
                return isNaN(d.getTime()) ? dateString : `${d.getFullYear()}년 ${String(d.getMonth() + 1).padStart(2, '0')}월 ${String(d.getDate()).padStart(2, '0')}일`;
            };

            let visitBtnText = isVisited ? (loc.VisitDate ? formatDate(loc.VisitDate) : '방문취소') : '방문완료';

            return `
                <div class="iw-container">
                    <span class="iw-title">${loc.Name}</span>
                    ${categoryTag}
                    <span class="iw-address">${loc.Address || '주소 정보 없음'}</span>
                    <div class="iw-btn-group">
                        <button onclick="updateStatus('${loc.ID}', ${!isVisited})" class="iw-btn ${isVisited ? 'btn-cancel' : 'btn-visit'}">
                            ${visitBtnText}
                        </button>
                        <a href="https://map.naver.com/v5/search/${encodeURIComponent(loc.Name)}" target="_blank" class="iw-btn btn-naver">네이버지도</a>
                    </div>
                </div>`;
        }

        function createMarker(loc) {
            locationsMap[loc.ID] = loc;
            var marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(loc.Lat, loc.Lng),
                map: map,
                icon: { content: getIconHtml(loc), anchor: new naver.maps.Point(12, 30) }
            });
            markersMap[loc.ID] = marker;
            naver.maps.Event.addListener(marker, "click", () => {
                infowindow.setContent(getInfoWindowHtml(locationsMap[loc.ID]));
                infowindow.open(map, marker);
            });
        }

        async function updateStatus(id, nextStatus) {
            const loc = locationsMap[id];
            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            loc.IsVisited = nextStatus ? 'TRUE' : 'FALSE'; 
            loc.VisitDate = nextStatus ? today : ""; 

            markersMap[id].setIcon({ content: getIconHtml(loc), anchor: new naver.maps.Point(12, 30) });
            infowindow.setContent(getInfoWindowHtml(loc));
            showToast("변경사항을 저장 중입니다...");

            try {
                await fetch(GOOGLE_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ id: id, isVisited: nextStatus, visitDate: loc.VisitDate }) 
                });
                showToast("저장이 완료되었습니다!");
            } catch (e) {
                showToast("저장에 실패했습니다.");
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        window.onload = initMap;
    </script>
</body>
</html>
